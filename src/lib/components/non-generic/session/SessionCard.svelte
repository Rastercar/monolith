<script lang="ts">
	import { apiDeleteUserSessionMutation } from '$lib/api/auth.queries';
	import type { UserSession } from '$lib/api/user.schema';
	import { getAuthContext } from '$lib/store/context';
	import Icon from '@iconify/svelte';
	import { UAParser } from 'ua-parser-js';

	type deviceType = 'console' | 'mobile' | 'tablet' | 'smarttv' | 'wearable' | 'embedded';

	interface Props {
		session: UserSession;

		/**
		 * the ID of the user that owns the session, if
		 * undefined its assumed the sesion belongs to the
		 * logged in user
		 */
		sessionOwnerId?: number;

		onDeleted: VoidFunction;
	}

	let { session, onDeleted, sessionOwnerId }: Props = $props();

	const uap = new UAParser(session.userAgent);
	const { type } = uap.getDevice();

	const typeToIcon: Record<deviceType, string> = {
		mobile: 'mdi:cellphone',
		tablet: 'mdi:tablet',
		smarttv: 'mdi:tv',
		console: 'mdi:console',
		embedded: 'mdi:raspberrypi',
		wearable: 'mdi:smartwatch'
	};

	const icon = typeToIcon[type as deviceType] ?? 'mdi:computer';

	const toDateStr = (d: Date) => {
		return d.toLocaleDateString(undefined, { hour: '2-digit', minute: 'numeric' });
	};

	const mutation = apiDeleteUserSessionMutation({
		minTime: 500,
		onSuccess: () => onDeleted()
	});

	const auth = getAuthContext();

	let canRemoveSessions = $derived(!sessionOwnerId || auth.hasPermission('LOGOFF_USER'));
</script>

<div class="flex flex-wrap items-center p-4 gap-4">
	<div class="flex items-center">
		<Icon {icon} height="32" />

		<div class="flex flex-col ml-4">
			<span>{uap.getOS().name ?? ''} {uap.getBrowser().name ?? ''} {session.ip}</span>
			<span class="text-surface-600-400 text-sm">
				data: {toDateStr(session.createdAt)}
			</span>
			<span class="text-surface-600-400 text-sm">
				expira em: {toDateStr(session.expiresAt)}
			</span>
		</div>
	</div>

	{#if session.sameAsFromRequest}
		<span class="chip preset-filled-primary-500 ml-auto py-1">sua sess達o atual</span>
	{:else if mutation.isError}
		<span class="chip preset-filled-error-400-600 ml-auto py-1">erro ao deletar sess達o</span>
	{:else if canRemoveSessions}
		<button
			disabled={mutation.isPending}
			type="button"
			class="btn preset-filled-warning-400-600 ml-auto"
			onclick={() => mutation.mutate({ sessionOwnerId, sessionPublicId: session.publicId })}
		>
			<span>{mutation.isPending ? 'removendo sess達o' : 'revogar sess達o'}</span>
			<Icon icon="mdi:trash" />
		</button>
	{/if}
</div>
